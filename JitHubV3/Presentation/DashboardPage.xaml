<local:ActivatablePage x:Class="JitHubV3.Presentation.DashboardPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:JitHubV3.Presentation"
  xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
  xmlns:layouts="using:JitHub.Dashboard.Layouts"
      xmlns:utu="using:Uno.Toolkit.UI"
      Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

  <local:ActivatablePage.Resources>
    <ResourceDictionary>
      <local:StringNullOrWhiteSpaceToVisibilityConverter x:Key="StringNullOrWhiteSpaceToVisibilityConverter" />

      <Style x:Key="DashboardRepoListItemStyle" TargetType="ListViewItem">
        <Setter Property="MinHeight" Value="44" />
        <Setter Property="Padding" Value="{StaticResource DashboardRepoItemPadding}" />
        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
      </Style>
    </ResourceDictionary>
  </local:ActivatablePage.Resources>

  <ContentControl x:Name="StateHost"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  HorizontalContentAlignment="Stretch"
                  VerticalContentAlignment="Stretch">
    <VisualStateManager.VisualStateGroups>
      <VisualStateGroup x:Name="DashboardWidthStates">
        <VisualState x:Name="Narrow">
          <VisualState.Setters>
            <Setter Target="NavView.PaneDisplayMode" Value="LeftMinimal" />
            <Setter Target="NavView.IsPaneOpen" Value="False" />
          </VisualState.Setters>
        </VisualState>

        <VisualState x:Name="Wide">
          <VisualState.Setters>
            <Setter Target="NavView.PaneDisplayMode" Value="Left" />
            <Setter Target="NavView.IsPaneOpen" Value="True" />
          </VisualState.Setters>
        </VisualState>
      </VisualStateGroup>
    </VisualStateManager.VisualStateGroups>

        <Grid utu:SafeArea.Insets="VisibleBounds"
          HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch">
      <NavigationView x:Name="NavView"
                      AutomationProperties.AutomationId="DashboardNavView"
                      IsBackButtonVisible="Collapsed"
                      IsSettingsVisible="False"
                      PaneDisplayMode="LeftMinimal"
                      IsPaneOpen="False">

        <NavigationView.PaneHeader>
          <TextBlock Text="JitHub"
                     Margin="{StaticResource DashboardEdgePadding}" />
        </NavigationView.PaneHeader>

        <NavigationView.PaneCustomContent>
          <Grid>
            <ListView ItemsSource="{Binding Repositories}"
                      AutomationProperties.AutomationId="DashboardRepoList"
                      ItemContainerStyle="{StaticResource DashboardRepoListItemStyle}"
                      SelectedValuePath="Id"
                      SelectedValue="{Binding SelectedRepositoryId, Mode=TwoWay}"
                      SelectionMode="Single"
                      Margin="{StaticResource DashboardEdgePadding}"
                      AutomationProperties.Name="Repositories">
              <ListView.ItemTemplate>
                <DataTemplate>
                  <Border BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                          BorderThickness="0,0,0,1">
                    <StackPanel Spacing="{StaticResource DashboardSpacingXS}">
                      <TextBlock Text="{Binding Name}"
                                 TextTrimming="CharacterEllipsis"
                                 TextWrapping="NoWrap" />

                      <TextBlock Text="{Binding OwnerLogin}"
                                 Opacity="0.72"
                                 TextTrimming="CharacterEllipsis"
                                 TextWrapping="NoWrap" />

                      <TextBlock Text="{Binding Description}"
                                 Visibility="{Binding Description, Converter={StaticResource StringNullOrWhiteSpaceToVisibilityConverter}}"
                                 Opacity="0.72"
                                 TextWrapping="Wrap"
                                 TextTrimming="CharacterEllipsis"
                                 MaxLines="2" />
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ListView.ItemTemplate>
            </ListView>
          </Grid>
        </NavigationView.PaneCustomContent>

        <NavigationView.Content>
          <Grid Padding="{StaticResource DashboardContentPaddingWithComposeClearance}">
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled">
              <layouts:CardDeckPresenter
                ItemsSource="{Binding Cards}"
                AutomationProperties.AutomationId="DashboardCardList"
                ModeWidthThreshold="{StaticResource DashboardGridToDeckMinWidth}"
                CardMinWidth="320"
                CardHeight="180"
                Spacing="{StaticResource DashboardSpacingL}"
                MaxColumns="3"
                DeckMaxVisibleCount="5"
                DeckOffsetY="{StaticResource DashboardSpacingM}"
                DeckAngleStepDegrees="1.25"
                DeckScaleStep="0.05"
                DeckBaseZ="{StaticResource DashboardElevationFloating}"
                DeckZStep="24"
                ItemTemplate="{StaticResource DashboardCardTemplate}" />
            </ScrollViewer>
          </Grid>
        </NavigationView.Content>
      </NavigationView>

      <!-- Compose box (ChatGPT-like; no-op for now). -->
      <Border x:Name="ComposeBox"
              AutomationProperties.AutomationId="DashboardComposeBox"
              VerticalAlignment="Bottom"
              HorizontalAlignment="Stretch"
              Margin="{StaticResource DashboardComposeMargin}"
              MaxWidth="{StaticResource DashboardComposeMaxWidth}"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="{StaticResource DashboardRadiusL}"
              Padding="{StaticResource DashboardComposePadding}">
        <Border.Shadow>
          <ThemeShadow />
        </Border.Shadow>

        <Grid ColumnSpacing="{StaticResource DashboardSpacingS}"
              RowSpacing="{StaticResource DashboardSpacingS}">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>

          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <TextBox x:Name="ComposeInput"
                   AutomationProperties.AutomationId="DashboardComposeInput"
                   Grid.Row="0"
                   Grid.Column="0"
                   Grid.ColumnSpan="2"
                   AcceptsReturn="True"
                   Text="{Binding ComposeText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                   TextWrapping="Wrap"
                   PlaceholderText="Ask anythingâ€¦"
                   HorizontalAlignment="Stretch"
                   VerticalAlignment="Stretch"
                   AutomationProperties.Name="Dashboard composer" />

            <Grid Grid.Row="1"
            Grid.Column="0"
            ColumnSpacing="{StaticResource DashboardSpacingS}">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>

              <ComboBox Grid.Column="0"
                  ItemsSource="{Binding AiModelOptions}"
                  SelectedItem="{Binding SelectedAiModel, Mode=TwoWay}"
                  DisplayMemberPath="DisplayName"
                  AutomationProperties.AutomationId="DashboardComposeModelPicker"
                  AutomationProperties.Name="AI model" />

              <Button Grid.Column="1"
                Content="Download"
                MinHeight="44"
                Command="{Binding DownloadSelectedAiModelCommand}"
                    Visibility="{Binding CanDownloadSelectedAiModel}" />

              <Button Grid.Column="2"
                Content="Cancel"
                MinHeight="44"
                Command="{Binding CancelAiModelDownloadCommand}"
                    Visibility="{Binding CanCancelAiModelDownload}" />
            </Grid>

            <Button Grid.Row="1"
              Grid.RowSpan="2"
              Grid.Column="1"
                  VerticalAlignment="Bottom"
                  MinWidth="44"
                  MinHeight="44"
                  Command="{Binding SubmitComposeCommand}"
                  AutomationProperties.Name="Send">
            <SymbolIcon Symbol="Send" />
          </Button>

            <StackPanel Grid.Row="2"
                  Grid.Column="0"
                  Spacing="{StaticResource DashboardSpacingXS}"
                  Visibility="{Binding IsAiModelDownloadVisible}">
              <ProgressBar IsIndeterminate="{Binding IsAiModelDownloadIndeterminate}"
               Value="{Binding AiModelDownloadProgressPercent}"
               Maximum="100" />

              <TextBlock Text="{Binding AiModelDownloadStatusText}"
                   Opacity="0.72"
                   TextWrapping="Wrap" />
            </StackPanel>
        </Grid>
      </Border>
    </Grid>
  </ContentControl>
</local:ActivatablePage>
