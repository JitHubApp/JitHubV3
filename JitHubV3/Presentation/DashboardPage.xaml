<local:ActivatablePage x:Class="JitHubV3.Presentation.DashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:JitHubV3.Presentation"
    xmlns:mp="using:JitHubV3.Presentation.Controls.ModelPicker"
  xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
  xmlns:layouts="using:JitHub.Dashboard.Layouts"
    xmlns:utu="using:Uno.Toolkit.UI"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

  <local:ActivatablePage.Resources>
    <ResourceDictionary>
      <local:StringNullOrWhiteSpaceToVisibilityConverter x:Key="StringNullOrWhiteSpaceToVisibilityConverter" />

      <Style x:Key="DashboardRepoListItemStyle" TargetType="ListViewItem">
        <Setter Property="MinHeight" Value="44" />
        <Setter Property="Padding" Value="{StaticResource DashboardRepoItemPadding}" />
        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
      </Style>
    </ResourceDictionary>
  </local:ActivatablePage.Resources>

  <ContentControl x:Name="StateHost"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  HorizontalContentAlignment="Stretch"
                  VerticalContentAlignment="Stretch">
    <VisualStateManager.VisualStateGroups>
      <VisualStateGroup x:Name="DashboardWidthStates">
        <VisualState x:Name="Narrow">
          <VisualState.Setters>
            <Setter Target="NavView.PaneDisplayMode" Value="LeftMinimal" />
            <Setter Target="NavView.IsPaneOpen" Value="False" />
          </VisualState.Setters>
        </VisualState>

        <VisualState x:Name="Wide">
          <VisualState.Setters>
            <Setter Target="NavView.PaneDisplayMode" Value="Left" />
            <Setter Target="NavView.IsPaneOpen" Value="True" />
          </VisualState.Setters>
        </VisualState>
      </VisualStateGroup>
    </VisualStateManager.VisualStateGroups>

        <Grid utu:SafeArea.Insets="VisibleBounds"
          HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch">
      <NavigationView x:Name="NavView"
                      AutomationProperties.AutomationId="DashboardNavView"
                      IsBackButtonVisible="Collapsed"
                      IsSettingsVisible="False"
                      PaneDisplayMode="LeftMinimal"
                      IsPaneOpen="False">

        <NavigationView.PaneHeader>
          <TextBlock Text="JitHub"
                     Margin="{StaticResource DashboardEdgePadding}" />
        </NavigationView.PaneHeader>

        <NavigationView.PaneCustomContent>
          <Grid>
            <ListView ItemsSource="{Binding Repositories}"
                      AutomationProperties.AutomationId="DashboardRepoList"
                      ItemContainerStyle="{StaticResource DashboardRepoListItemStyle}"
                      SelectedValuePath="Id"
                      SelectedValue="{Binding SelectedRepositoryId, Mode=TwoWay}"
                      SelectionMode="Single"
                      Margin="{StaticResource DashboardEdgePadding}"
                      AutomationProperties.Name="Repositories">
              <ListView.ItemTemplate>
                <DataTemplate>
                  <Border BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                          BorderThickness="0,0,0,1">
                    <StackPanel Spacing="{StaticResource DashboardSpacingXS}">
                      <TextBlock Text="{Binding Name}"
                                 TextTrimming="CharacterEllipsis"
                                 TextWrapping="NoWrap" />

                      <TextBlock Text="{Binding OwnerLogin}"
                                 Opacity="0.72"
                                 TextTrimming="CharacterEllipsis"
                                 TextWrapping="NoWrap" />

                      <TextBlock Text="{Binding Description}"
                                 Visibility="{Binding Description, Converter={StaticResource StringNullOrWhiteSpaceToVisibilityConverter}}"
                                 Opacity="0.72"
                                 TextWrapping="Wrap"
                                 TextTrimming="CharacterEllipsis"
                                 MaxLines="2" />
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ListView.ItemTemplate>
            </ListView>
          </Grid>
        </NavigationView.PaneCustomContent>

        <NavigationView.Content>
          <Grid Padding="{StaticResource DashboardContentPaddingWithComposeClearance}">
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled">
              <layouts:CardDeckPresenter
                ItemsSource="{Binding Cards}"
                AutomationProperties.AutomationId="DashboardCardList"
                ModeWidthThreshold="{StaticResource DashboardGridToDeckMinWidth}"
                CardMinWidth="320"
                CardHeight="180"
                Spacing="{StaticResource DashboardSpacingL}"
                MaxColumns="3"
                DeckMaxVisibleCount="5"
                DeckOffsetY="{StaticResource DashboardSpacingM}"
                DeckAngleStepDegrees="1.25"
                DeckScaleStep="0.05"
                DeckBaseZ="{StaticResource DashboardElevationFloating}"
                DeckZStep="24"
                ItemTemplate="{StaticResource DashboardCardTemplate}" />
            </ScrollViewer>
          </Grid>
        </NavigationView.Content>
      </NavigationView>

      <!-- Compose box (ChatGPT-like; no-op for now). -->
      <Border x:Name="ComposeBox"
              AutomationProperties.AutomationId="DashboardComposeBox"
              VerticalAlignment="Bottom"
              HorizontalAlignment="Stretch"
              Margin="{StaticResource DashboardComposeMargin}"
              MaxWidth="{StaticResource DashboardComposeMaxWidth}"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="{StaticResource DashboardRadiusL}"
              Padding="{StaticResource DashboardComposePadding}">
        <Border.Shadow>
          <ThemeShadow />
        </Border.Shadow>

        <Grid ColumnSpacing="{StaticResource DashboardSpacingS}"
              RowSpacing="{StaticResource DashboardSpacingS}">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>

          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <TextBox x:Name="ComposeInput"
                   AutomationProperties.AutomationId="DashboardComposeInput"
                   Grid.Row="0"
                   Grid.Column="0"
                   Grid.ColumnSpan="2"
                   AcceptsReturn="True"
                   Text="{Binding ComposeText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                   TextWrapping="Wrap"
                   PlaceholderText="Ask anything…"
                   HorizontalAlignment="Stretch"
                   VerticalAlignment="Stretch"
                   AutomationProperties.Name="Dashboard composer" />

          <StackPanel Grid.Row="1"
                      Grid.Column="0"
                      Orientation="Horizontal"
                      Spacing="{StaticResource DashboardSpacingS}">
            <ToggleSwitch x:Uid="DashboardPage.Toggle.AiEnabled"
                          AutomationProperties.AutomationId="DashboardComposeAiToggle"
                          Header="AI"
                          MinHeight="44"
                          IsOn="{Binding IsAiEnabled, Mode=TwoWay}"
                          AutomationProperties.Name="AI enabled" />

            <Button x:Uid="DashboardPage.Button.AiSettings"
                    AutomationProperties.AutomationId="DashboardComposeAiSettings"
                    MinWidth="44"
                    MinHeight="44"
                    Command="{Binding OpenAiModelPickerCommand}"
                    AutomationProperties.Name="AI settings">
              <SymbolIcon Symbol="Setting" />
            </Button>

            <Button x:Uid="DashboardPage.Button.AiInfo"
                    AutomationProperties.AutomationId="DashboardComposeAiInfo"
                    MinWidth="44"
                    MinHeight="44"
                    AutomationProperties.Name="AI info">
              <SymbolIcon Symbol="Help" />

              <Button.Flyout>
                <Flyout Placement="Top">
                  <StackPanel Spacing="{StaticResource DashboardSpacingXS}">
                    <TextBlock x:Uid="DashboardPage.AiInfo.Title"
                               Text="Natural language search (not chat)."
                               Style="{ThemeResource TitleTextBlockStyle}"
                               TextWrapping="Wrap" />

                    <TextBlock x:Uid="DashboardPage.AiInfo.Body"
                               Text="Your input is converted into GitHub queries."
                               Style="{ThemeResource BodyTextBlockStyle}"
                               Opacity="0.72"
                               TextWrapping="Wrap" />

                    <TextBlock x:Uid="DashboardPage.AiInfo.Status"
                               Text="AI: On/Off · Runtime/Model · HW"
                               Style="{ThemeResource BodyTextBlockStyle}"
                               Opacity="0.72"
                               TextWrapping="Wrap" />
                  </StackPanel>
                </Flyout>
              </Button.Flyout>
            </Button>
          </StackPanel>

            <Button Grid.Row="1"
              Grid.RowSpan="2"
              Grid.Column="1"
                  VerticalAlignment="Bottom"
                  MinWidth="44"
                  MinHeight="44"
                  Command="{Binding SubmitComposeCommand}"
                  AutomationProperties.Name="Send">
            <SymbolIcon Symbol="Send" />
          </Button>

          <!-- Download UI moved to the picker dialog (Phase 2+). -->
        </Grid>
      </Border>

      <mp:ModelOrApiPickerOverlay DataContext="{Binding AiModelPicker}" />
    </Grid>
  </ContentControl>
</local:ActivatablePage>
