<UserControl
    x:Class="JitHubV3.Presentation.Controls.ModelPicker.FoundryLocalPickerView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:JitHubV3.Presentation.Controls.ModelPicker"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    x:Name="Root"
    mc:Ignorable="d">

  <Grid>
    <ProgressRing
      x:Name="LoadingIndicator"
      Width="36"
      Height="36"
      HorizontalAlignment="Center"
      VerticalAlignment="Center"
      IsActive="True" />

    <ScrollViewer x:Name="ModelsView" Visibility="Collapsed">
      <Grid Padding="{StaticResource DashboardEdgePadding}" RowSpacing="{StaticResource DashboardSpacingS}">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel
          Margin="0,12,0,24"
          HorizontalAlignment="Center"
          Orientation="Vertical"
          Spacing="{StaticResource DashboardSpacingXS}"
          Visibility="{x:Bind ViewModel.ShowEmptyState, Mode=OneWay}">
          <FontIcon
            Margin="0,0,0,12"
            FontSize="24"
            Glyph="&#xF158;" />
          <TextBlock
            HorizontalAlignment="Center"
            Style="{ThemeResource BodyStrongTextBlockStyle}"
            Text="No models downloaded"
            TextAlignment="Center" />
          <TextBlock
            HorizontalAlignment="Center"
            Opacity="0.72"
            Text="Download a local model below"
            TextAlignment="Center" />
        </StackPanel>

        <ListView
          Grid.Row="0"
          ItemsSource="{x:Bind ViewModel.AvailableModels, Mode=OneWay}"
          SelectedItem="{x:Bind ViewModel.SelectedModel, Mode=TwoWay}"
          SelectionMode="Single">
          <ListView.ItemTemplate>
            <DataTemplate x:DataType="local:FoundryModelPairViewModel">
              <Border
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="{StaticResource DashboardRadiusM}"
                Padding="{StaticResource DashboardEdgePadding}">
                <Grid ColumnSpacing="{StaticResource DashboardSpacingS}">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>

                  <StackPanel>
                    <TextBlock
                      Text="{x:Bind Name}"
                      TextTrimming="CharacterEllipsis"
                      TextWrapping="NoWrap" />
                    <TextBlock
                      Opacity="0.72"
                      Text="{x:Bind ExecutionProviderShort}"
                      TextWrapping="NoWrap" />
                  </StackPanel>

                  <TextBlock
                    Grid.Column="1"
                    Opacity="0.72"
                    Text="{x:Bind local:FoundryLocalText.FormatBytes(SizeBytes)}" />
                </Grid>
              </Border>
            </DataTemplate>
          </ListView.ItemTemplate>
        </ListView>

        <Grid Grid.Row="1" Margin="0,16,0,8">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <TextBlock
            Opacity="0.72"
            Text="Available models on Foundry Local" />

          <HyperlinkButton
            Grid.Column="1"
            Padding="0"
            HorizontalAlignment="Right"
            Command="{x:Bind ViewModel.CopyUrlCommand}">
            <StackPanel Orientation="Horizontal" Spacing="{StaticResource DashboardSpacingXS}">
              <TextBlock Text="{x:Bind ViewModel.FoundryLocalUrl, Mode=OneWay}" />
              <FontIcon FontSize="12" Glyph="&#xE8C8;" />
            </StackPanel>
          </HyperlinkButton>
        </Grid>

        <ItemsRepeater Grid.Row="2" ItemsSource="{x:Bind ViewModel.CatalogModels, Mode=OneWay}">
          <ItemsRepeater.Layout>
            <StackLayout Spacing="{StaticResource DashboardSpacingS}" />
          </ItemsRepeater.Layout>
          <ItemsRepeater.ItemTemplate>
            <DataTemplate x:DataType="local:FoundryCatalogModelGroupViewModel">
              <Border
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="{StaticResource DashboardRadiusM}"
                Padding="{StaticResource DashboardEdgePadding}">
                <Grid RowSpacing="{StaticResource DashboardSpacingXS}">
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                  </Grid.RowDefinitions>

                  <Grid ColumnSpacing="{StaticResource DashboardSpacingS}">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock
                      Text="{x:Bind Alias}"
                      TextTrimming="CharacterEllipsis"
                      TextWrapping="NoWrap" />

                    <Button Grid.Column="1" Content="Download">
                      <Button.Flyout>
                        <Flyout Placement="Bottom">
                          <ItemsRepeater ItemsSource="{x:Bind Models, Mode=OneWay}">
                            <ItemsRepeater.Layout>
                              <StackLayout Spacing="{StaticResource DashboardSpacingXS}" />
                            </ItemsRepeater.Layout>
                            <ItemsRepeater.ItemTemplate>
                              <DataTemplate x:DataType="local:DownloadableFoundryModelViewModel">
                                <Button
                                  MinHeight="34"
                                  IsEnabled="{x:Bind CanDownload, Mode=OneWay}"
                                                  Command="{Binding DataContext.DownloadModelCommand, ElementName=Root}"
                                                  CommandParameter="{Binding}">
                                  <StackPanel Orientation="Horizontal" Spacing="{StaticResource DashboardSpacingXS}">
                                    <Grid Width="24" Height="24">
                                      <FontIcon
                                        FontSize="16"
                                        Glyph="&#xE896;"
                                        Visibility="{x:Bind CanDownload, Mode=OneWay}" />
                                      <ProgressRing
                                        Width="24"
                                        Height="24"
                                        IsIndeterminate="False"
                                        Value="{x:Bind Progress, Mode=OneWay}"
                                                        Visibility="{x:Bind local:FoundryLocalPickerView.BoolToVisibilityInverse(CanDownload)}" />
                                    </Grid>
                                    <TextBlock Text="{x:Bind DisplayText}" TextWrapping="NoWrap" />
                                  </StackPanel>
                                </Button>
                              </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                          </ItemsRepeater>
                        </Flyout>
                      </Button.Flyout>
                    </Button>
                  </Grid>

                  <ItemsRepeater Grid.Row="1" ItemsSource="{x:Bind Details, Mode=OneWay}">
                    <ItemsRepeater.Layout>
                      <StackLayout Orientation="Horizontal" Spacing="{StaticResource DashboardSpacingXS}" />
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                      <DataTemplate x:DataType="local:FoundryCatalogModelDetailsViewModel">
                        <Button Content="{x:Bind ExecutionProviderShort}">
                          <Button.Flyout>
                            <Flyout>
                              <TextBlock TextWrapping="Wrap">
                                <Run Text="This model can run on your " />
                                <Run Text="{x:Bind RuntimeDeviceType}" />
                                <Run Text=" with the " />
                                <Run Text="{x:Bind RuntimeExecutionProvider}" />
                              </TextBlock>
                            </Flyout>
                          </Button.Flyout>
                        </Button>
                      </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                  </ItemsRepeater>
                </Grid>
              </Border>
            </DataTemplate>
          </ItemsRepeater.ItemTemplate>
        </ItemsRepeater>
      </Grid>
    </ScrollViewer>

    <Grid x:Name="NotAvailableGrid" Visibility="Collapsed">
      <StackPanel
        Margin="48,0,48,48"
        HorizontalAlignment="Center"
        VerticalAlignment="Center"
        Orientation="Vertical"
        Spacing="{StaticResource DashboardSpacingS}">
        <Image Width="36" Source="ms-appx:///Assets/ModelIcons/local.svg" />
        <TextBlock
          Style="{ThemeResource BodyStrongTextBlockStyle}"
          Text="Foundry Local is not installed on this machine"
          TextAlignment="Center" />
        <TextBlock
          Opacity="0.72"
          IsTextSelectionEnabled="True"
          TextAlignment="Center"
          TextWrapping="Wrap">
          <LineBreak />
          <Hyperlink NavigateUri="https://aka.ms/fl-install-from-gallery" UnderlineStyle="None">Install Foundry Local</Hyperlink>
          <LineBreak />
          <LineBreak />
          <Run Text="You will be able to download and use models once Foundry Local is installed on this machine." />
        </TextBlock>
      </StackPanel>
    </Grid>

    <VisualStateManager.VisualStateGroups>
      <VisualStateGroup x:Name="StateGroup">
        <VisualState x:Name="ShowLoading" />
        <VisualState x:Name="ShowModels">
          <VisualState.Setters>
            <Setter Target="LoadingIndicator.Visibility" Value="Collapsed" />
            <Setter Target="NotAvailableGrid.Visibility" Value="Collapsed" />
            <Setter Target="ModelsView.Visibility" Value="Visible" />
          </VisualState.Setters>
        </VisualState>
        <VisualState x:Name="ShowNotAvailable">
          <VisualState.Setters>
            <Setter Target="LoadingIndicator.Visibility" Value="Collapsed" />
            <Setter Target="NotAvailableGrid.Visibility" Value="Visible" />
            <Setter Target="ModelsView.Visibility" Value="Collapsed" />
          </VisualState.Setters>
        </VisualState>
      </VisualStateGroup>
    </VisualStateManager.VisualStateGroups>
  </Grid>
</UserControl>
