# Source Generator: ModelType Enum Generation - Complete Technical Analysis

## Overview

The `FoundryCatalogModel.ModelType` property is **NOT generated** by the source generator. Instead, it's a simple string property that holds JSON data received from the Foundry Local service API. However, the **application-wide `ModelType` enum** that the app uses throughout its codebase IS generated by a sophisticated Roslyn source generator.

## Key Distinction

There are **two different "ModelType" concepts**:

1. **`FoundryCatalogModel.ModelType`** (string property)
   - Location: `AIDevGallery\ExternalModelUtils\FoundryLocal\FoundryCatalogModel.cs`
   - Type: `string`
   - Purpose: Stores model type data from Foundry Local API response
   - Source: API JSON deserialization
   - Example values: "text-completion", "chat", "embedding", etc.

2. **`AIDevGallery.Models.ModelType`** (enum)
   - Location: Generated at compile-time ? `ModelType.g.cs`
   - Type: `enum`
   - Purpose: Application-wide enum for categorizing all models
   - Source: Source generator reading JSON definition files
   - Example values: `Phi3Mini`, `HRNetPose`, `PhiSilica`, etc.

## Source Generator Architecture

### Project: AIDevGallery.SourceGenerator

**Target Framework**: .NET Standard 2.0 (required for Roslyn source generators)

**Key Files**:
- `ModelsSourceGenerator.cs` - Main generator implementation
- `Models/Model.cs` - Deserialization model for `.model.json` files
- `Models/ModelFamily.cs` - Deserialization model for model families
- `Models/ModelGroup.cs` - Deserialization model for `.modelgroup.json` files
- `Models/ApiGroup.cs` / `ApiDefinition.cs` - For API definitions

### Generator Initialization

```csharp
[Generator(LanguageNames.CSharp)]
internal class ModelSourceGenerator : IIncrementalGenerator
{
    public void Initialize(IncrementalGeneratorInitializationContext context)
    {
        // Filter for JSON files in Samples\Definitions\ folder
        IncrementalValuesProvider<AdditionalText> modelJsons = 
            context.AdditionalTextsProvider.Where(
                static file => file.Path.EndsWith(".json") && 
                              file.Path.Contains(@"\Samples\Definitions\"));

        // Collect all matching files and their contents
        var pathsAndContents = modelJsons.Select((text, cancellationToken) =>
                (text.Path, 
                 Content: text.GetText(cancellationToken)!.ToString(), 
                 CancellationToken: cancellationToken))
            .Collect();

        // Register the source generation callback
        context.RegisterSourceOutput(pathsAndContents, Execute);
    }
}
```

**How it works**:
1. Scans for all `.json` files in `AIDevGallery\Samples\Definitions\`
2. Reads their contents during compilation
3. Generates C# code based on the JSON definitions

## JSON Input Files

The generator processes three types of JSON files:

### 1. `.model.json` - Single Model Family

**Example**: `resnet.model.json`

```json
{
  "ResNet": {
    "Id": "resnet",
    "Name": "ResNet",
    "Description": "ResNet is a convolutional neural network...",
    "DocsUrl": "https://github.com/onnx/models/tree/main/vision/classification/resnet",
    "ReadmeUrl": "https://github.com/onnx/models/blob/main/vision/classification/resnet/README.md",
    "Models": {
      "ResNet101V17": {
        "Id": "a6b56e2f-1d42-4e1d-bb43-b9ca2c4e9f35",
        "Name": "ResNet-101 v1.7",
        "Url": "https://github.com/onnx/models/blob/main/vision/classification/resnet/model/resnet101-v1-7.onnx",
        "Description": "ResNet-101 v1.7 model",
        "HardwareAccelerator": ["CPU", "DML"],
        "Size": 178728956,
        "ParameterSize": "101",
        "License": "apache-2.0",
        "InputDimensions": [[1, 3, 224, 224]],
        "OutputDimensions": [[1, 1000]]
      },
      "ResNet50V17": {
        "Id": "b7c67f3g-2e53-5f2e-cc54-c0db3d5f0g46",
        "Name": "ResNet-50 v1.7",
        "Url": "https://github.com/onnx/models/blob/main/vision/classification/resnet/model/resnet50-v1-7.onnx",
        "Description": "ResNet-50 v1.7 model",
        "HardwareAccelerator": ["CPU", "DML"],
        "Size": 102530888,
        "ParameterSize": "50",
        "License": "apache-2.0"
      }
    }
  }
}
```

**Generates enum values**:
```csharp
internal enum ModelType
{
    ResNet,              // From the top-level key
    ResNetResNet101V17,  // From ResNet + ResNet101V17
    ResNetResNet50V17,   // From ResNet + ResNet50V17
    // ...
}
```

### 2. `.modelgroup.json` - Multiple Model Families

**Example**: `languagemodels.modelgroup.json`

```json
{
  "LanguageModels": {
    "Id": "615e2f1c-ea95-4c34-9d22-b1e8574fe476",
    "Name": "Language",
    "Icon": "\uE8BD",
    "Order": 1,
    "Models": {
      "Phi3Mini": {
        "Id": "phi3mini",
        "Name": "Phi 3 Mini",
        "Description": "Phi-3 Mini is a 3.8B parameter model...",
        "DocsUrl": "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-onnx",
        "Models": {
          "Phi3MiniDirectML": {
            "Id": "202d6eaa-7a65-4d40-b2c3-53f1ef12a4eb",
            "Name": "Phi 3 Mini DirectML",
            "Url": "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-onnx/tree/main/directml/directml-int4-awq-block-128",
            "Description": "Phi 3 Mini DirectML will run on your GPU",
            "HardwareAccelerator": "DML",
            "Size": 2135763374,
            "ParameterSize": "3.8B",
            "PromptTemplate": "Phi3",
            "License": "mit"
          },
          "Phi3MiniCPU": {
            "Id": "8c7d4a1b-3e2f-4c5a-9b8e-1f6d2a3c4e5f",
            "Name": "Phi 3 Mini CPU",
            "Url": "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-onnx/tree/main/cpu_and_mobile/cpu-int4-rtn-block-32-acc-level-4",
            "HardwareAccelerator": "CPU",
            "Size": 2395242683,
            "ParameterSize": "3.8B",
            "PromptTemplate": "Phi3",
            "License": "mit"
          }
        },
        "ReadmeUrl": "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-onnx/blob/main/README.md"
      },
      "Mistral": {
        // ... another model family
      }
    }
  }
}
```

**Generates enum values**:
```csharp
internal enum ModelType
{
    LanguageModels,           // Top-level group
    Phi3Mini,                 // Model family
    Phi3MiniPhi3MiniDirectML, // Phi3Mini + Phi3MiniDirectML
    Phi3MiniPhi3MiniCPU,      // Phi3Mini + Phi3MiniCPU
    Mistral,                  // Another family
    MistralMistral7B,         // Mistral + variant
    // ...
}
```

### 3. `apis.json` - Windows AI APIs

**Example**: `apis.json`

```json
{
  "WCRAPIs": {
    "Id": "wcrapis",
    "Name": "Windows AI",
    "Icon": "\uE950",
    "Order": 2,
    "Apis": {
      "PhiSilica": {
        "Id": "phisilica",
        "Name": "Phi Silica",
        "Icon": "ms-appx:///Assets/ModelIcons/PhiSilica.png",
        "IconGlyph": "\\uF0E2",
        "Description": "Phi Silica is a local language model...",
        "ReadmeUrl": "https://learn.microsoft.com/windows/ai/...",
        "License": "MIT"
      },
      "TextSummarizer": {
        "Id": "textsummarizer",
        "Name": "Text Summarizer",
        "Icon": "ms-appx:///Assets/ModelIcons/TextSummarizer.png",
        "Description": "Summarize text using the Windows AI API",
        "ReadmeUrl": "https://learn.microsoft.com/windows/ai/...",
        "License": "MIT"
      }
    }
  }
}
```

**Generates enum values**:
```csharp
internal enum ModelType
{
    WCRAPIs,       // API group
    PhiSilica,     // Individual API
    TextSummarizer,
    // ...
}
```

## Code Generation Process

### Execute Method Flow

```csharp
public void Execute(SourceProductionContext context, 
    ImmutableArray<(string Path, string Content, CancellationToken CancellationToken)> modelJsons)
{
    Dictionary<string, object> modelTypes = [];
    var sourceBuilder = new StringBuilder();

    // 1. Start enum declaration
    sourceBuilder.AppendLine(
        """
        #nullable enable

        using System.Collections.Generic;

        namespace AIDevGallery.Models;
        
        internal enum ModelType
        {
        """);

    // 2. Process each JSON file
    foreach (var modelJson in modelJsons)
    {
        switch (modelJson.Path)
        {
            case var path when path.EndsWith("apis.json"):
                var apiGroups = JsonSerializer.Deserialize(
                    modelJson.Content, 
                    SourceGenerationContext.Default.DictionaryStringApiGroup);
                AddApis(sourceBuilder, apiGroups);
                break;

            case var path when path.EndsWith(".model.json"):
                var modelFamilies = JsonSerializer.Deserialize(
                    modelJson.Content, 
                    SourceGenerationContext.Default.DictionaryStringModelFamily);
                
                foreach (var modelFamily in modelFamilies)
                {
                    // Add family enum value
                    AddEnumValue(sourceBuilder, modelFamily.Key, modelFamily);
                    
                    // Add each model variant
                    foreach (var model in modelFamily.Value.Models)
                    {
                        // Concatenate family + variant name
                        AddEnumValue(sourceBuilder, 
                            $"{modelFamily.Key}{model.Key}", 
                            model);
                    }
                }
                break;

            case var path when path.EndsWith(".modelgroup.json"):
                var modelGroups = JsonSerializer.Deserialize(
                    modelJson.Content, 
                    SourceGenerationContext.Default.DictionaryStringModelGroup);
                
                foreach (var modelGroup in modelGroups)
                {
                    // Add group enum value
                    AddEnumValue(sourceBuilder, modelGroup.Key, modelGroup);
                    
                    // Add each family in the group
                    foreach (var modelFamily in modelGroup.Value.Models)
                    {
                        AddEnumValue(sourceBuilder, modelFamily.Key, modelFamily);
                        
                        // Add each variant in the family
                        foreach (var model in modelFamily.Value.Models)
                        {
                            AddEnumValue(sourceBuilder, 
                                $"{modelFamily.Key}{model.Key}", 
                                model);
                        }
                    }
                }
                break;
        }
    }

    // 3. Close enum declaration
    sourceBuilder.AppendLine("}");

    // 4. Output the generated source file
    context.AddSource("ModelType.g.cs", 
        SourceText.From(sourceBuilder.ToString(), Encoding.UTF8));

    // 5. Generate helper dictionaries
    GenerateModelTypeHelpersFile(context, modelTypes);
}
```

### AddEnumValue Helper

```csharp
bool AddEnumValue<T>(StringBuilder sourceBuilder, 
                     string enumValueName, 
                     KeyValuePair<string, T> dict)
{
    if (dict.Value != null)
    {
        // Add to enum
        sourceBuilder.AppendLine($"    {enumValueName},");
        
        // Track for helper generation
        modelTypes.Add(enumValueName, dict.Value);
        
        // Validation for models
        if (dict.Value is Model model &&
            (model.Size == null || model.Size == 0 ||
            string.IsNullOrWhiteSpace(model.Id)))
        {
            return false; // Indicates incomplete model definition
        }
    }

    return true;
}
```

## Generated Output Files

### 1. ModelType.g.cs

**Location**: `obj\Debug\net9.0\generated\...`

```csharp
#nullable enable

using System.Collections.Generic;

namespace AIDevGallery.Models;

internal enum ModelType
{
    AudioModels,
    Whisper,
    WhisperWhisperTinyCPU,
    WhisperWhisperSmallCPU,
    WhisperWhisperMediumCPU,
    LanguageModels,
    Phi4Mini,
    Phi4MiniPhi4MiniGPU,
    Phi4MiniPhi4MiniCPU,
    Phi3_5Mini,
    Phi3_5MiniPhi3_5MiniCPUACC4,
    Phi3Mini,
    Phi3MiniPhi3MiniDirectML,
    Phi3MiniPhi3MiniCPU,
    Phi3MiniPhi3MiniCPUACC4,
    // ... 60+ more values
    WCRAPIs,
    PhiSilica,
    PhiSilicaLora,
    TextSummarizer,
    TextRewriter,
    // ... etc.
}
```

### 2. ModelTypeHelpers.g.cs

This file contains several helper dictionaries and methods:

#### A. ModelDetails Dictionary

Maps `ModelType` enum values to full `ModelDetails` objects:

```csharp
internal static class ModelTypeHelpers
{
    internal static Dictionary<ModelType, ModelDetails> ModelDetails { get; } = new ()
    {
        {
            ModelType.Phi3MiniPhi3MiniDirectML,
            new ModelDetails
            {
                Name = "Phi 3 Mini DirectML",
                Id = "202d6eaa-7a65-4d40-b2c3-53f1ef12a4eb",
                Description = "Phi 3 Mini DirectML will run on your GPU",
                Url = "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-onnx/tree/main/directml/directml-int4-awq-block-128",
                HardwareAccelerators = [ HardwareAccelerator.DML ],
                SupportedOnQualcomm = null,
                Size = 2135763374,
                ParameterSize = "3.8B",
                PromptTemplate = PromptTemplateHelpers.PromptTemplates[PromptTemplateType.Phi3],
                Icon = string.Empty,
                License = "mit",
                FileFilters = [ ],
                AIToolkitActions = [ AIToolkitAction.Playground, AIToolkitAction.PromptBuilder ],
                AIToolkitId = "Phi-3-mini-4k-directml-int4-awq-block-128-onnx",
                AIToolkitFinetuningId = null,
                InputDimensions = null,
                OutputDimensions = null
            }
        },
        // ... more entries
    };
}
```

#### B. ModelFamilyDetails Dictionary

Maps family-level `ModelType` values to `ModelFamily` objects:

```csharp
internal static Dictionary<ModelType, ModelFamily> ModelFamilyDetails { get; } = new ()
{
    {
        ModelType.Phi3Mini,
        new ModelFamily
        {
            Id = "phi3mini",
            Name = "Phi 3 Mini",
            Description = "Phi-3 Mini is a 3.8B parameter, lightweight, state-of-the-art open language model",
            DocsUrl = "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-onnx",
            ReadmeUrl = "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-onnx/blob/main/README.md",
        }
    },
    // ... more families
};
```

#### C. ApiDefinitionDetails Dictionary

Maps API `ModelType` values to `ApiDefinition` objects:

```csharp
internal static Dictionary<ModelType, ApiDefinition> ApiDefinitionDetails { get; } = new ()
{
    {
        ModelType.PhiSilica,
        new ApiDefinition
        {
            Id = "phisilica",
            Name = "Phi Silica",
            Icon = "ms-appx:///Assets/ModelIcons/PhiSilica.png",
            IconGlyph = "\\uF0E2",
            Description = "Phi Silica is a local language model...",
            ReadmeUrl = "https://learn.microsoft.com/windows/ai/...",
            License = "MIT"
        }
    },
    // ... more APIs
};
```

#### D. ModelGroupDetails Dictionary

Maps group-level `ModelType` values:

```csharp
internal static Dictionary<ModelType, ModelGroup> ModelGroupDetails { get; } = new ()
{
    {
        ModelType.LanguageModels,
        new ModelGroup
        {
            Id = "615e2f1c-ea95-4c34-9d22-b1e8574fe476",
            Name = "Language",
            Icon = "\uE8BD",
            IsApi = false
        }
    },
    {
        ModelType.WCRAPIs,
        new ModelGroup
        {
            Id = "wcrapis",
            Name = "Windows AI",
            Icon = "\uE950",
            IsApi = true
        }
    },
    // ... more groups
};
```

#### E. ParentMapping Dictionary

Defines the hierarchy - which `ModelType` values are children of which parents:

```csharp
internal static Dictionary<ModelType, List<ModelType>> ParentMapping { get; } = new ()
{
    // Group ? Families
    { 
        ModelType.LanguageModels, 
        [
            ModelType.Phi4Mini, 
            ModelType.Phi3_5Mini, 
            ModelType.Phi3Mini, 
            ModelType.Phi3Medium, 
            ModelType.Mistral
        ] 
    },
    
    // Family ? Variants
    { 
        ModelType.Phi3Mini, 
        [
            ModelType.Phi3MiniPhi3MiniDirectML, 
            ModelType.Phi3MiniPhi3MiniCPU, 
            ModelType.Phi3MiniPhi3MiniCPUACC4
        ] 
    },
    
    // API Group ? APIs
    { 
        ModelType.WCRAPIs, 
        [
            ModelType.PhiSilica, 
            ModelType.TextSummarizer, 
            ModelType.TextRewriter,
            // ... etc.
        ] 
    },
    
    // Leaf nodes (individual APIs/models with no children)
    { ModelType.PhiSilica, [] },
    { ModelType.TextSummarizer, [] },
    // ... etc.
};
```

#### F. GetModelOrder Method

Returns display order for navigation:

```csharp
internal static int GetModelOrder(ModelType modelType)
{
    return modelType switch
    {
        ModelType.LanguageModels => 1,
        ModelType.WCRAPIs => 2,
        ModelType.AudioModels => 3,
        ModelType.MultimodalModels => 4,
        ModelType.ImageModels => 5,
        ModelType.GenerativeModels => 6,
        ModelType.EmbeddingModel => 7,
        _ => int.MaxValue,
    };
}
```

## Usage in Application Code

### Example 1: Sample Attribute

```csharp
[GallerySample(
    Model1Types = [ModelType.HRNetPose],  // Uses generated enum
    Scenario = ScenarioType.ImageDetectPose,
    Name = "Pose Detection",
    Id = "9b74ccc0-f5f7-430f-bed0-712ffc063508",
    Icon = "\uE8B3")]
internal sealed partial class PoseDetection : BaseSamplePage
{
    // ...
}
```

### Example 2: Retrieving Model Details

```csharp
// In ModelDetailsHelper.cs
public static List<ModelDetails> GetModelDetailsForModelType(ModelType initialModelType)
{
    Queue<ModelType> leafs = new();
    leafs.Enqueue(initialModelType);
    
    // Traverse hierarchy using ParentMapping
    while (leafs.Count > 0)
    {
        var leaf = leafs.Dequeue();
        
        if (ModelTypeHelpers.ParentMapping.TryGetValue(leaf, out List<ModelType>? children))
        {
            foreach (var child in children)
            {
                leafs.Enqueue(child);
            }
        }
    }
    
    // Convert to ModelDetails
    var allModelDetails = new List<ModelDetails>();
    foreach (var modelType in leafs.ToList())
    {
        if (ModelTypeHelpers.ModelDetails.TryGetValue(modelType, out ModelDetails? details))
        {
            allModelDetails.Add(details);
        }
    }
    
    return allModelDetails;
}
```

### Example 3: Navigation Menu

```csharp
// In ModelSelectionPage.cs
private void SetUpModels()
{
    List<ModelType> rootModels = [
        ..ModelTypeHelpers.ModelGroupDetails.Keys
    ];
    
    foreach (var key in rootModels.OrderBy(ModelTypeHelpers.GetModelOrder))
    {
        var navItem = CreateFromItem(key, includeChildren: true);
        NavView.MenuItems.Add(navItem);
    }
}
```

## Build Integration

### Project File References

**AIDevGallery.SourceGenerator.csproj**:
```xml
<ItemGroup>
  <EmbeddedResource Include="..\AIDevGallery\Samples\scenarios.json" Visible="False" />
  <EmbeddedResource Include="..\AIDevGallery\Samples\promptTemplates.json" Visible="False" />
</ItemGroup>

<ItemGroup>
  <ProjectReference Include="..\AIDevGallery.Utils\AIDevGallery.Utils.csproj" />
</ItemGroup>
```

**AIDevGallery.csproj**:
```xml
<ItemGroup>
  <ProjectReference Include="..\AIDevGallery.SourceGenerator\AIDevGallery.SourceGenerator.csproj" 
                    OutputItemType="Analyzer" 
                    ReferenceOutputAssembly="false" />
</ItemGroup>

<ItemGroup>
  <!-- All JSON files in Samples\Definitions\ are automatically included as AdditionalFiles -->
  <AdditionalFiles Include="Samples\Definitions\**\*.json" />
</ItemGroup>
```

## Key Differences: FoundryCatalogModel.ModelType vs Generated ModelType

| Aspect | FoundryCatalogModel.ModelType | AIDevGallery.Models.ModelType |
|--------|------------------------------|-------------------------------|
| **Type** | `string` | `enum` |
| **Source** | Foundry Local API JSON response | Source generator from definition files |
| **Purpose** | Store API metadata | Application-wide model categorization |
| **Values** | API-defined (e.g., "text-completion") | App-defined (e.g., `Phi3Mini`) |
| **Scope** | Only Foundry Local models | ALL models and APIs in the app |
| **Generation** | Runtime deserialization | Compile-time code generation |
| **Usage** | Internal to FoundryLocal provider | Throughout entire application |

## Summary

1. **`FoundryCatalogModel.ModelType`** is a simple string property that stores JSON data from Foundry Local API - it is NOT generated.

2. **`AIDevGallery.Models.ModelType`** is an enum generated at compile-time by a Roslyn source generator that:
   - Scans all `.model.json`, `.modelgroup.json`, and `apis.json` files
   - Creates enum values for groups, families, and individual model variants
   - Generates helper dictionaries (`ModelTypeHelpers`) for runtime lookups
   - Enables type-safe model references throughout the application

3. The source generator runs during build and produces two files:
   - `ModelType.g.cs` - The enum declaration
   - `ModelTypeHelpers.g.cs` - Helper dictionaries and methods

4. This architecture allows developers to:
   - Define models in declarative JSON files
   - Get compile-time type safety with the enum
   - Maintain a single source of truth for model definitions
   - Automatically update the app when JSON definitions change

The naming collision is coincidental - they serve completely different purposes in different contexts.
